<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate of Analysis Generator (Serverless)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for printing */
        @media print {
            @page {
                margin: 0;
            }
            body {
                margin: 2cm;
            }
            body * {
                visibility: hidden;
            }
            #coa-container, #coa-container * {
                visibility: visible;
            }
            #coa-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 98vh;
            }
            .no-print {
                display: none;
            }
        }
        /* Custom scrollbar for history */
        #historyList::-webkit-scrollbar {
            width: 6px;
        }
        #historyList::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #historyList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #historyList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .font-arial {
            font-family: Arial, sans-serif;
        }
        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-700 no-print">성적서(COA) 생성기</h1>
        
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Input Data Section -->
            <div class="lg:w-1/3 bg-white p-6 rounded-lg shadow-lg no-print">
                <h2 class="text-2xl font-semibold mb-3 border-b pb-2">데이터 입력</h2>
                
                <!-- Duksan Search Section -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
                    <label for="duksanLotNumberInput" class="block text-md font-semibold text-gray-800 mb-2">Duksan LOT 번호 조회</label>
                    <input type="text" id="duksanLotNumberInput" placeholder="LOT 번호를 입력하세요 (예: P81202)" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button id="duksanSearchButton" onclick="searchAndPopulateDuksanData()" class="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center">
                        <span id="buttonText">덕산 데이터 자동 조회</span>
                        <svg id="loadingSpinner" class="hidden loading-spinner w-4 h-4 ml-2 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    
                    <!-- Status message area -->
                    <div id="searchStatus" class="mt-2 text-sm"></div>
                    
                    <p class="text-xs text-gray-500 mt-2">버튼을 누르면 데이터를 자동으로 조회하여 아래 '성적서 데이터' 칸을 채웁니다.</p>
                </div>

                <div class="mb-4" hidden>
                    <label for="excelDataInput" class="block text-sm font-medium text-gray-700 mb-1">제품 데이터 (Excel/JSON)</label>
                    <textarea id="excelDataInput" class="w-full h-40 border border-gray-300 rounded-md p-3 text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" spellcheck="false">[
    {
        "Product code": 2672,
        "Product No.": "A18",
        "2nd Item Number": "D10020",
        "Description": "Acetone (Certified ACS), Fisher Chemical",
        "Retest date": 5
    },
    {
        "Product code": 2670,
        "Product No.": "A40",
        "2nd Item Number": "D10022",
        "Description": "Acetone, Pesticide Grade",
        "Retest date": 3
    },
    {
        "Product code": 7954,
        "Product No.": "A416",
        "2nd Item Number": "D10028",
        "Description": "2-Propanol, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 2723,
        "Product No.": "A450",
        "2nd Item Number": "D10027",
        "Description": "Methanol (Methyl alcohol), Pesticide Grade",
        "Retest date": 3
    },
    {
        "Product code": 2717,
        "Product No.": "A451",
        "2nd Item Number": "D10014",
        "Description": "2-Propanol (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 1704,
        "Product No.": "A452",
        "2nd Item Number": "D10003",
        "Description": "Methanol (Methyl alcohol), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7530,
        "Product No.": "A456",
        "2nd Item Number": "K11991",
        "Description": "Methanol, Optima® LC/MS grade",
        "Retest date": 2
    },
    {
        "Product code": 7865,
        "Product No.": "A461",
        "2nd Item Number": "K11993",
        "Description": "Isopropanol, Optima® LC/MS grade",
        "Retest date": 3
    },
    {
        "Product code": 7312,
        "Product No.": "A516",
        "2nd Item Number": "K12620",
        "Description": "2-Propanol (USP), Fisher Chemical",
        "Retest date": 5
    },
    {
        "Product code": 2668,
        "Product No.": "A949",
        "2nd Item Number": "D10015",
        "Description": "Acetone, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7531,
        "Product No.": "A955",
        "2nd Item Number": "K12002",
        "Description": "Acetonitrile, Optima™ LC/MS Grade",
        "Retest date": 3
    },
    {
        "Product code": 2716,
        "Product No.": "A9951",
        "2nd Item Number": "D10037",
        "Description": "Ethanol, absolute, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 1697,
        "Product No.": "A995",
        "2nd Item Number": "D10001",
        "Description": "Ethanol, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 1698,
        "Product No.": "A998",
        "2nd Item Number": "D10002",
        "Description": "Acetonitrile (ACN), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2676,
        "Product No.": "A999",
        "2nd Item Number": "D10018",
        "Description": "Acetonitrile (ACN), Pesticide",
        "Retest date": 3
    },
    {
        "Product code": 2664,
        "Product No.": "C606",
        "2nd Item Number": "D10024",
        "Description": "Chloroform (Approx. 0.75% Ethanol as Preservative/HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2782,
        "Product No.": "C620",
        "2nd Item Number": "D10034",
        "Description": "Cyclohexane, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2789,
        "Product No.": "D114",
        "2nd Item Number": "D10031",
        "Description": "1,4-Dioxane , HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2995,
        "Product No.": "D118",
        "2nd Item Number": "D10021",
        "Description": "N,N-Dimethylformamide (DMF), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2982,
        "Product No.": "D142",
        "2nd Item Number": "D10011",
        "Description": "Methylene Chloride (Pesticide), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2659,
        "Product No.": "D143",
        "2nd Item Number": "D10008",
        "Description": "Methylene Chloride (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 7578,
        "Product No.": "D159",
        "2nd Item Number": "K12872",
        "Description": "Dimethyl Sulfoxide (HPLC Grade), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 3974,
        "Product No.": "E127",
        "2nd Item Number": "D10036",
        "Description": "Methyl tert-Butyl Ether (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2690,
        "Product No.": "E138",
        "2nd Item Number": "D10012",
        "Description": "Ethyl Ether Anhydrous (Certified ACS), Fisher Chemical™",
        "Retest date": 5
    },
    {
        "Product code": 1734,
        "Product No.": "E195",
        "2nd Item Number": "D10019",
        "Description": "Ethyl acetate, HPLC Grade",
        "Retest date": 2
    },
    {
        "Product code": 1915,
        "Product No.": "E198",
        "2nd Item Number": "D10025",
        "Description": "Ethyl Ether, Anhydrous (Stabilized/HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2794,
        "Product No.": "H300",
        "2nd Item Number": "D10013",
        "Description": "Hexanes (Pesticide), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 826,
        "Product No.": "H302",
        "2nd Item Number": "D10009",
        "Description": "Hexanes, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7663,
        "Product No.": "H306",
        "2nd Item Number": "D10023",
        "Description": "n-Hexane, ACS Grade",
        "Retest date": 3
    },
    {
        "Product code": 2701,
        "Product No.": "H350",
        "2nd Item Number": "D10016",
        "Description": "n-Heptane, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7638,
        "Product No.": "H350D",
        "2nd Item Number": "D10043",
        "Description": "n-Heptane, Anhydrous ",
        "Retest date": 3
    },
    {
        "Product code": 3469,
        "Product No.": "O296",
        "2nd Item Number": "D10035",
        "Description": "Isooctane (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 2767,
        "Product No.": "P399",
        "2nd Item Number": "K13266",
        "Description": "Pentane (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 2582,
        "Product No.": "T290",
        "2nd Item Number": "D10017",
        "Description": "Toluene (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2899,
        "Product No.": "T397",
        "2nd Item Number": "D10010",
        "Description": "Tetrahydrofuran (Certified), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 1695,
        "Product No.": "T425",
        "2nd Item Number": "D10005",
        "Description": "Tetrahydrofuran (HPLC), unstabilized, Fisher Chemical",
        "Retest date": 1
    },
    {
        "Product code": 1952,
        "Product No.": "W5",
        "2nd Item Number": "D10004",
        "Description": "Water (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 7529,
        "Product No.": "W6",
        "2nd Item Number": "K12468",
        "Description": "Water, Optima™ LC/MS Grade, Fisher Chemical™",
        "Retest date": 2
    },
    {
        "Product code": 1649,
        "Product No.": "X5",
        "2nd Item Number": "D10007",
        "Description": "Xylenes, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 2678,
        "Product No.": "A383",
        "2nd Item Number": "D10026",
        "Description": "1-Butanol (n-Butyl alcohol),HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2195,
        "Product No.": "A412",
        "2nd Item Number": "D10006",
        "Description": "Methanol, ACS Grade ",
        "Retest date": 5
    }
]
                    </textarea>
                </div>

                <div>
                    <label for="dataInput" class="block text-sm font-medium text-gray-700 mb-1">성적서 데이터</label>
                    <textarea id="dataInput" class="w-full h-60 border border-gray-300 rounded-md p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" spellcheck="false">
Acetonitrile [75-05-8]
Product code. 1698
Lot-P81202
TESTS	UNIT	SPECIFICATION	RESULTS
Appearance	-	Clear, colorless liquid	Clear, colorless liquid
Absorbance	Pass/Fail	Pass test	Pass test
Assay	%	≥ 99.95	99.99
Color	APHA	≤ 5	2
Density at 25 Degrees C	GM/ML	Inclusive Between 0.775~0.780	0.777
Evaporation residue	ppm	≤ 1	≤ 1
Fluorescence Background	Pass/Fail	To pass test	Pass test
Identification	Pass/Fail	To pass test	Pass test
LC Gradient Suitability	Pass/Fail	To pass test	Pass test
Optical Absorbance 190 nm	Abs.unit	≤ 1.00	0.45
Optical Absorbance 195 nm	Abs.unit	≤ 0.15	0.11
Optical Absorbance 200 nm	Abs.unit	≤ 0.07	0.03
Optical Absorbance 205 nm	Abs.unit	≤ 0.05	0.02
Optical Absorbance 210 nm	Abs.unit	≤ 0.04	0.018
Optical Absorbance 220 nm	Abs.unit	≤ 0.02	0.009
Optical Absorbance 254 nm	Abs.unit	≤ 0.01	0.002
Refractive index @ 25 Deg C	-	Inclusive Between 1.3405~1.3425	1.342
Titratable Acid	mEq/g	≤ 0.008	0.0006
Titratable Base	mEq/g	≤ 0.0006	0.00001
Water (H2O)	%	≤ 0.01	0.004
Mfg. Date :2025-08-19
Exp. Date :3 years after Mfg. Date
                    </textarea>
                </div>
                
                <div class="mt-4 space-y-3">
                    <div>
                        <label for="manualProductNo" class="block text-sm font-medium text-gray-700">Product No. (수동 입력)</label>
                        <input type="text" id="manualProductNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualLotNumber" class="block text-sm font-medium text-gray-700">LOT Number (수동 입력)</label>
                        <input type="text" id="manualLotNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualDescription" class="block text-sm font-medium text-gray-700">Description (수동 입력)</label>
                        <input type="text" id="manualDescription" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualRetestDate" class="block text-sm font-medium text-gray-700">Retest Date (수동 입력)</label>
                        <input type="text" id="manualRetestDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                </div>

                <button onclick="populateCoa(true)" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    COA 생성 (Populate)
                </button>
                 <button onclick="window.print()" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out">
                    인쇄 (Print)
                </button>

                <!-- History Section -->
                <div id="historyContainer" class="mt-6 border-t pt-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">History</h3>
                        <button onclick="clearHistory()" class="text-sm text-red-500 hover:text-red-700">Clear History</button>
                    </div>
                    <div id="historyList" class="mt-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-gray-50 space-y-1">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- COA Display Section -->
            <div class="lg:w-2/3">
                <div id="coa-container" class="bg-white p-8 sm:p-12 rounded-lg shadow-lg flex flex-col min-h-screen print:min-h-[100vh]">
                    <header class="flex justify-between items-start mb-8">
                        <div>
                            <img src="logo.png" alt="Company Logo" class="h-16">
                        </div>
                        <div class="text-right text-xs text-gray-600">
                            <p class="font-bold text-base">Thermo Fisher Scientific Korea</p>
                            <p class="font-bold mt-2">(Incheon Airport Logistics Complex)</p>
                            <p>D5,D6 150 Gonghangdong-ro 296 beon-gil</p>
                            <p>Jung-gu, Incheon 2239, Korea</p>
                            <p>Tel. +82-2-2023-0600</p>
                            <p>Fax. +82-2-6196-5501,2</p>
                        </div>
                    </header>

                    <h2 class="text-center text-3xl font-bold my-2 pb-4 border-b-4 border-gray-800">Certificate of Analysis</h2>

                    <div class="mb-2 text-sm space-y-1 pt-0 font-arial">
                        <div class="flex"><strong class="w-48 font-normal">Product No.:</strong><span id="productNo"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">LOT Number:</strong><span id="lotNumber"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">CAS Number:</strong><span id="casNumber"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Description:</strong><span id="description"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Quality Test/Release Date:</strong><span id="releaseDate"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Retest Date:</strong><span id="retestDate"></span></div>
                    </div>
            <div class="flex-grow">
                        <table class="w-full border-collapse text-sm font-arial">
                            <thead>
                                <tr class="border-b-4 border-gray-800">
                                    <th class="pb-2 p-2 text-left font-semibold">Result Name</th>
                                    <th class="pb-2 p-2 text-left font-semibold">Units</th>
                                    <th class="pb-2 p-2 text-left font-semibold">Specifications</th>
                                    <th class="pb-2 p-2 text-left font-semibold">Test Value</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Rows will be inserted by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <footer class="mt-12 pt-4">
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-500 w-2/3">
                                <p>Note: The data listed is valid for all package sizes of this lot of this product, expressed as an extension of this catalog number listed above. If there are any questions with this certificate, please call at (82)-2-2023-0600.</p>
                                <p class="mt-2">*Based on suggested storage condition.</p>
                            </div>
                            <div class="text-center">
                                 <img src="sign.png" alt="Signature" class="h-16 mx-auto">
                                 <p class="font-semibold mt-2">Guseon.Jeong - Quality Control Supervisor</p>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <script>
        const HISTORY_KEY = 'coaGeneratorHistory';

        // 제품 매핑 데이터베이스
        const productMapping = {
            'acetonitrile': { code: '1698', productNo: 'A998', description: 'Acetonitrile (ACN), HPLC Grade', retest: 3 },
            'methanol': { code: '1704', productNo: 'A452', description: 'Methanol (Methyl alcohol), HPLC Grade', retest: 3 },
            'methyl alcohol': { code: '1704', productNo: 'A452', description: 'Methanol (Methyl alcohol), HPLC Grade', retest: 3 },
            'acetone': { code: '2672', productNo: 'A18', description: 'Acetone (Certified ACS), Fisher Chemical', retest: 5 },
            'ethanol': { code: '2716', productNo: 'A9951', description: 'Ethanol, absolute, ACS Grade', retest: 5 },
            'isopropanol': { code: '7954', productNo: 'A416', description: '2-Propanol, ACS Grade', retest: 5 },
            '2-propanol': { code: '7954', productNo: 'A416', description: '2-Propanol, ACS Grade', retest: 5 }
        };

        // ★★★ UPDATED: Serverless function integration ★★★
        async function searchAndPopulateDuksanData() {
            const lotInput = document.getElementById('duksanLotNumberInput');
            const lotNumber = lotInput.value.trim();

            if (!lotNumber) {
                alert("LOT 번호를 입력해주세요.");
                return;
            }

            showLoading(true);
            showStatus('데이터를 조회 중입니다...', 'loading');

            try {
                // Call our serverless function
                const response = await fetch(`https://coa-transfer.vercel.app/api/scrape?lot_no=${encodeURIComponent(lotNumber)}`);
                
                console.log("Response status:", response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `서버 오류: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("Received data:", data);

                if (!data.success) {
                    throw new Error(data.error || "해당 Lot 번호에 대한 데이터가 없습니다.");
                }

                if (!data.tests || data.tests.length === 0) {
                    throw new Error("테스트 결과 데이터가 없습니다.");
                }

                // 제품 정보 추출
                let productName = "";
                let productCode = "";
                let casNumber = "";
                let retestYears = 3; // 기본값

                // API에서 제공하는 제품 정보 사용
                if (data.product && data.product.name && data.product.name !== 'Unknown Product') {
                    productName = data.product.name;
                }
                if (data.product && data.product.code) {
                    productCode = data.product.code;
                }
                if (data.product && data.product.casNumber) {
                    casNumber = data.product.casNumber;
                }

                // 제품 이름으로 매핑 시도
                if (productName) {
                    const normalizedName = productName.toLowerCase().trim();
                    for (const [key, value] of Object.entries(productMapping)) {
                        if (normalizedName.includes(key)) {
                            productCode = value.code;
                            retestYears = value.retest;
                            // 이미 API에서 가져온 제품 이름을 사용하거나 매핑된 설명 사용
                            if (!data.product.name || data.product.name === 'Unknown Product') {
                                productName = value.description;
                            }
                            break;
                        }
                    }
                }

                // 테스트 데이터에서 제품 이름 감지 (백업)
                if (!productName && data.tests.length > 0) {
                    const firstTest = data.tests[0].test || '';
                    const normalizedTest = firstTest.toLowerCase();
                    for (const [key, value] of Object.entries(productMapping)) {
                        if (normalizedTest.includes(key)) {
                            productName = value.description;
                            productCode = value.code;
                            retestYears = value.retest;
                            break;
                        }
                    }
                }

                // Format the fetched JSON data into the text format for the textarea
                let formattedText = '';
                
                formattedText += `${productName || 'Chemical Product'} [${casNumber || 'N/A'}]\n`;
                
                if (productCode) {
                    formattedText += `Product code. ${productCode}\n`;
                }
                
                formattedText += `Lot-${lotNumber}\n`;
                formattedText += 'TESTS\tUNIT\tSPECIFICATION\tRESULTS\n';
                
                data.tests.forEach(item => {
                    const resultName = item.test || item.item || 'N/A';
                    const units = item.unit || 'N/A';
                    const specs = item.specification || item.spec || 'N/A';
                    const testValue = item.result || 'N/A';
                    formattedText += `${resultName}\t${units}\t${specs}\t${testValue}\n`;
                });

                // Add manufacturing date if available from manual inputs or use current date
                const currentDate = new Date().toISOString().split('T')[0];
                formattedText += `Mfg. Date :${currentDate}\n`;
                formattedText += `Exp. Date :${retestYears} years after Mfg. Date\n`;

                // Populate the textarea
                document.getElementById('dataInput').value = formattedText;
                
                // Auto-fill manual inputs
                if (productName && !document.getElementById('manualDescription').value) {
                    document.getElementById('manualDescription').value = productName;
                }
                if (productCode && !document.getElementById('manualProductNo').value) {
                    // 제품 코드 대신 Product No. 사용
                    const productNo = Object.values(productMapping).find(p => p.code === productCode)?.productNo || productCode;
                    document.getElementById('manualProductNo').value = productNo;
                }
                
                if (!document.getElementById('manualLotNumber').value) {
                    document.getElementById('manualLotNumber').value = lotNumber;
                }

                // Generate COA and save to history
                populateCoa(true);
                
                // Show success message
                showStatus(`데이터를 성공적으로 가져왔습니다. ${data.tests.length}개의 테스트 항목을 찾았습니다.`, 'success');

            } catch (error) {
                console.error("Fetch Error:", error);
                
                let errorMessage = "데이터를 가져오는 중 오류가 발생했습니다.";
                
                if (error.message.includes('timeout')) {
                    errorMessage = "웹사이트 응답이 너무 느립니다. 잠시 후 다시 시도해주세요.";
                } else if (error.message.includes('404')) {
                    errorMessage = "해당 Lot 번호에 대한 데이터를 찾을 수 없습니다.";
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = "서버에 연결할 수 없습니다. 인터넷 연결을 확인해주세요.";
                } else {
                    errorMessage = error.message;
                }
                
                showStatus(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Status message functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('searchStatus');
            const className = type === 'success' ? 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative' : 
                             type === 'error' ? 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative' : 
                             'bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative';
            
            statusDiv.innerHTML = `<div class="${className}" role="alert">${message}</div>`;
        }

        function clearStatus() {
            const statusDiv = document.getElementById('searchStatus');
            statusDiv.innerHTML = '';
        }

        function showLoading(show) {
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const searchButton = document.getElementById('duksanSearchButton');
            
            if (show) {
                buttonText.textContent = '조회 중...';
                loadingSpinner.classList.remove('hidden');
                searchButton.disabled = true;
            } else {
                buttonText.textContent = '덕산 데이터 자동 조회';
                loadingSpinner.classList.add('hidden');
                searchButton.disabled = false;
            }
        }

        // Enter key support for the search input
        document.getElementById('duksanLotNumberInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchAndPopulateDuksanData();
            }
        });

        /**
         * Calculates a retest date string in YYYY-MM-DD format with -1 day.
         * @param {string} baseDateStr - The starting date in 'YYYY-MM-DD' format.
         * @param {number} yearsToAdd - The number of years to add.
         * @returns {string} The calculated date string or an empty string if invalid.
         */
        function calculateRetestDate(baseDateStr, yearsToAdd) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(baseDateStr) || !Number.isFinite(yearsToAdd)) {
                return '';
            }
            try {
                const date = new Date(baseDateStr);
                date.setFullYear(date.getFullYear() + yearsToAdd);
                date.setDate(date.getDate() - 1); // Subtract 1 day
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("Error calculating date:", e);
                return '';
            }
        }

        function populateCoa(saveToHistory = false) {
            // Clear previous UI
            const elements = {
                productNo: document.getElementById('productNo'),
                lotNumber: document.getElementById('lotNumber'),
                casNumber: document.getElementById('casNumber'),
                description: document.getElementById('description'),
                releaseDate: document.getElementById('releaseDate'),
                retestDate: document.getElementById('retestDate'),
                tableBody: document.getElementById('resultsTableBody')
            };
            Object.values(elements).forEach(el => el.innerHTML = '');

            // Get manual inputs
            const manualInputs = {
                productNo: document.getElementById('manualProductNo').value.trim(),
                lotNumber: document.getElementById('manualLotNumber').value.trim(),
                description: document.getElementById('manualDescription').value.trim(),
                retestDate: document.getElementById('manualRetestDate').value.trim()
            };

            // Parse product database
            let productDatabase = [];
            try {
                productDatabase = JSON.parse(document.getElementById('excelDataInput').value.trim());
            } catch (e) {
                console.error("Invalid JSON in product database:", e);
                alert("제품 데이터 형식이 올바르지 않습니다.");
                return;
            }

            const rawData = document.getElementById('dataInput').value;
            const lines = rawData.split('\n');
            
            // --- 1. Extract all possible info from raw text ---
            let parsedInfo = {
                productCode: '',
                lotNumber: '',
                casNumber: '',
                description: '',
                mfgDate: '',
                expDateText: '' // Store the raw text from Exp. Date line
            };

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                if (lowerLine.startsWith('product code.')) {
                    const match = line.match(/Product code\.\s*(\d+)/);
                    if (match && match[1]) parsedInfo.productCode = match[1];
                }
                if (lowerLine.startsWith('lot-')) {
                    parsedInfo.lotNumber = line.split('-')[1]?.trim() || '';
                }
                if (line.includes('[') && line.includes(']')) {
                    parsedInfo.description = line.substring(0, line.indexOf('[')).trim();
                    parsedInfo.casNumber = line.substring(line.indexOf('[') + 1, line.indexOf(']')).trim();
                }
                if (lowerLine.startsWith('mfg. date')) {
                     const dateMatch = line.match(/\d{4}-\d{2}-\d{2}/);
                     if (dateMatch) parsedInfo.mfgDate = dateMatch[0];
                }
                if (lowerLine.startsWith('exp. date')) {
                    parsedInfo.expDateText = line.split(':')[1]?.trim() || '';
                }
            });

            // --- 2. Look up product in DB and auto-populate manual inputs ---
            let productFromDb = null;
            if (parsedInfo.productCode && productDatabase.length > 0) {
                productFromDb = productDatabase.find(p => String(p["Product code"]) === parsedInfo.productCode);
                
                // Auto-populate manual inputs if empty
                if (productFromDb) {
                    if (!manualInputs.productNo && productFromDb["Product No."]) {
                        document.getElementById('manualProductNo').value = productFromDb["Product No."];
                        manualInputs.productNo = productFromDb["Product No."];
                    }
                    if (!manualInputs.description && productFromDb["Description"]) {
                        document.getElementById('manualDescription').value = productFromDb["Description"];
                        manualInputs.description = productFromDb["Description"];
                    }
                }
            }

            // --- 3. Auto-detect product information if missing ---
            if (!parsedInfo.description && !manualInputs.description) {
                // Try to auto-detect from test data
                const firstLine = lines[0]?.toLowerCase() || '';
                for (const [key, value] of Object.entries(productMapping)) {
                    if (firstLine.includes(key)) {
                        parsedInfo.description = value.description;
                        parsedInfo.productCode = value.code;
                        break;
                    }
                }
            }

            // --- 4. Populate final values based on priority ---
            elements.productNo.textContent = manualInputs.productNo || (productFromDb ? productFromDb["Product No."] : '') || parsedInfo.productCode;
            elements.description.textContent = manualInputs.description || parsedInfo.description || (productFromDb ? productFromDb["Description"] : '');
            elements.lotNumber.textContent = manualInputs.lotNumber || parsedInfo.lotNumber;
            elements.casNumber.textContent = parsedInfo.casNumber;
            elements.releaseDate.textContent = parsedInfo.mfgDate;
            
            // Retest Date Priority Logic with -1 day calculation
            let finalRetestDate = '';
            if (manualInputs.retestDate) {
                finalRetestDate = manualInputs.retestDate;
            } else if (parsedInfo.expDateText && parsedInfo.mfgDate) {
                  const yearsMatch = parsedInfo.expDateText.match(/(\d+)\s*years/);
                  if (yearsMatch && yearsMatch[1]) {
                      const years = parseInt(yearsMatch[1], 10);
                      finalRetestDate = calculateRetestDate(parsedInfo.mfgDate, years);
                  } else {
                      finalRetestDate = parsedInfo.expDateText;
                  }
            } else if (productFromDb && parsedInfo.mfgDate) {
                const years = parseInt(productFromDb["Retest date"], 10);
                finalRetestDate = calculateRetestDate(parsedInfo.mfgDate, years);
            } else if (parsedInfo.description) {
                // Try to get retest years from product mapping
                const normalizedDesc = parsedInfo.description.toLowerCase();
                for (const [key, value] of Object.entries(productMapping)) {
                    if (normalizedDesc.includes(key) && parsedInfo.mfgDate) {
                        finalRetestDate = calculateRetestDate(parsedInfo.mfgDate, value.retest);
                        break;
                    }
                }
            }
            elements.retestDate.textContent = finalRetestDate;

            // --- 5. Populate table ---
            let isTableData = false;
            lines.forEach(line => {
                if (line.toLowerCase().startsWith('tests\tunit\tspecification\tresults')) {
                    isTableData = true;
                    return;
                }
                if (line.toLowerCase().startsWith('mfg. date')) {
                    isTableData = false;
                }
                if (isTableData && line.trim()) {
                    const parts = line.split('\t');
                    if (parts.length >= 4) {
                        const [resultName, units, specs, testValue] = parts;
                        const row = `<tr><td class="px-2 py-0.5">${resultName.trim()}</td><td class="px-2 py-0.5">${units.trim()}</td><td class="px-2 py-0.5">${specs.trim()}</td><td class="px-2 py-0.5">${testValue.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td></tr>`;
                        elements.tableBody.innerHTML += row;
                    }
                }
            });

            // --- 6. Save to history ---
            if (saveToHistory) {
                const historyEntry = {
                    rawData: rawData,
                    productNo: elements.productNo.textContent,
                    lotNumber: elements.lotNumber.textContent,
                    manualProductNo: manualInputs.productNo,
                    manualLotNumber: manualInputs.lotNumber,
                    manualDescription: manualInputs.description,
                    manualRetestDate: manualInputs.retestDate,
                    timestamp: new Date().toISOString()
                };
                addHistoryEntry(historyEntry);
            }
        }

        // --- History Functions ---
        function getHistory() {
            const historyJson = localStorage.getItem(HISTORY_KEY);
            return historyJson ? JSON.parse(historyJson) : [];
        }

        function addHistoryEntry(entry) {
            if (!entry.lotNumber && !entry.productNo) return;
            let history = getHistory();
            history = history.filter(item => !(item.lotNumber === entry.lotNumber && item.productNo === entry.productNo));
            history.unshift(entry);
            if (history.length > 20) {
                history.pop();
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            loadHistoryDisplay();
        }

        function loadHistoryDisplay() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-xs text-gray-500 text-center p-2">No history yet.</p>';
                return;
            }

            history.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'p-2 border-b last:border-b-0 text-sm cursor-pointer hover:bg-blue-100 rounded';
                item.innerHTML = `
                    <p class="font-semibold truncate">No.: ${entry.productNo || 'N/A'}</p>
                    <p class="text-xs text-gray-600">Lot: ${entry.lotNumber || 'N/A'}</p>
                `;
                item.onclick = () => applyHistoryEntry(index);
                historyList.appendChild(item);
            });
        }

        function applyHistoryEntry(index) {
            const history = getHistory();
            const entry = history[index];
            if (entry) {
                document.getElementById('dataInput').value = entry.rawData;
                document.getElementById('manualProductNo').value = entry.manualProductNo || '';
                document.getElementById('manualLotNumber').value = entry.manualLotNumber || '';
                document.getElementById('manualDescription').value = entry.manualDescription || '';
                document.getElementById('manualRetestDate').value = entry.manualRetestDate || '';
                populateCoa(false);
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                 localStorage.removeItem(HISTORY_KEY);
                 loadHistoryDisplay();
            }
        }

        window.onload = () => {
            populateCoa(false);
            loadHistoryDisplay();
        };
    </script>
</body>
</html>
