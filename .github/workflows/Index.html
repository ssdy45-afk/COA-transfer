<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate of Analysis Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for printing */
        @media print {
            @page {
                margin: 0;
            }
            body {
                margin: 2cm;
            }
            body * {
                visibility: hidden;
            }
            #coa-container, #coa-container * {
                visibility: visible;
            }
            #coa-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 98vh; /* Ensure it tries to fill the print page */
            }
            .no-print {
                display: none;
            }
        }
        /* Custom scrollbar for history */
        #historyList::-webkit-scrollbar {
            width: 6px;
        }
        #historyList::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #historyList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #historyList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .font-arial {
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-700 no-print">성적서(COA) 생성기</h1>
        
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Input Data Section -->
            <div class="lg:w-1/3 bg-white p-6 rounded-lg shadow-lg no-print">
                <h2 class="text-2xl font-semibold mb-3 border-b pb-2">데이터 입력</h2>
                
                <!-- Duksan Search Section -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
                    <label for="duksanLotNumberInput" class="block text-md font-semibold text-gray-800 mb-2">Duksan LOT 번호 조회</label>
                    <input type="text" id="duksanLotNumberInput" placeholder="LOT 번호를 입력하세요 (예: P36101)" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button onclick="searchDuksanLotNumber()" class="mt-2 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                        덕산 성적서 열기
                    </button>
                    <p class="text-xs text-gray-500 mt-2">버튼을 눌러 성적서를 연 후, 필요한 데이터를 복사하여 아래 '성적서 데이터' 칸에 붙여넣으세요.</p>
                </div>

                <div class="mb-4" hidden>
                    <label for="excelDataInput" class="block text-sm font-medium text-gray-700 mb-1">제품 데이터 (Excel/JSON)</label>
                    <textarea id="excelDataInput" class="w-full h-40 border border-gray-300 rounded-md p-3 text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" spellcheck="false">[
    {
        "Product code": 2672,
        "Product No.": "A18",
        "2nd Item Number": "D10020",
        "Description": "Acetone (Certified ACS), Fisher Chemical",
        "Retest date": 5
    },
    {
        "Product code": 2670,
        "Product No.": "A40",
        "2nd Item Number": "D10022",
        "Description": "Acetone, Pesticide Grade",
        "Retest date": 3
    },
    {
        "Product code": 7954,
        "Product No.": "A416",
        "2nd Item Number": "D10028",
        "Description": "2-Propanol, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 2723,
        "Product No.": "A450",
        "2nd Item Number": "D10027",
        "Description": "Methanol (Methyl alcohol), Pesticide Grade",
        "Retest date": 3
    },
    {
        "Product code": 2717,
        "Product No.": "A451",
        "2nd Item Number": "D10014",
        "Description": "2-Propanol (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 1704,
        "Product No.": "A452",
        "2nd Item Number": "D10003",
        "Description": "Methanol (Methyl alcohol), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7530,
        "Product No.": "A456",
        "2nd Item Number": "K11991",
        "Description": "Methanol, Optima® LC/MS grade",
        "Retest date": 2
    },
    {
        "Product code": 7865,
        "Product No.": "A461",
        "2nd Item Number": "K11993",
        "Description": "Isopropanol, Optima® LC/MS grade",
        "Retest date": 3
    },
    {
        "Product code": 7312,
        "Product No.": "A516",
        "2nd Item Number": "K12620",
        "Description": "2-Propanol (USP), Fisher Chemical",
        "Retest date": 5
    },
    {
        "Product code": 2668,
        "Product No.": "A949",
        "2nd Item Number": "D10015",
        "Description": "Acetone, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7531,
        "Product No.": "A955",
        "2nd Item Number": "K12002",
        "Description": "Acetonitrile, Optima™ LC/MS Grade",
        "Retest date": 3
    },
    {
        "Product code": 2716,
        "Product No.": "A9951",
        "2nd Item Number": "D10037",
        "Description": "Ethanol, absolute, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 1697,
        "Product No.": "A995",
        "2nd Item Number": "D10001",
        "Description": "Ethanol, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 1698,
        "Product No.": "A998",
        "2nd Item Number": "D10002",
        "Description": "Acetonitrile (ACN), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2676,
        "Product No.": "A999",
        "2nd Item Number": "D10018",
        "Description": "Acetonitrile (ACN), Pesticide",
        "Retest date": 3
    },
    {
        "Product code": 2664,
        "Product No.": "C606",
        "2nd Item Number": "D10024",
        "Description": "Chloroform (Approx. 0.75% Ethanol as Preservative/HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2782,
        "Product No.": "C620",
        "2nd Item Number": "D10034",
        "Description": "Cyclohexane, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2789,
        "Product No.": "D114",
        "2nd Item Number": "D10031",
        "Description": "1,4-Dioxane , HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2995,
        "Product No.": "D118",
        "2nd Item Number": "D10021",
        "Description": "N,N-Dimethylformamide (DMF), HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2982,
        "Product No.": "D142",
        "2nd Item Number": "D10011",
        "Description": "Methylene Chloride (Pesticide), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2659,
        "Product No.": "D143",
        "2nd Item Number": "D10008",
        "Description": "Methylene Chloride (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 7578,
        "Product No.": "D159",
        "2nd Item Number": "K12872",
        "Description": "Dimethyl Sulfoxide (HPLC Grade), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 3974,
        "Product No.": "E127",
        "2nd Item Number": "D10036",
        "Description": "Methyl tert-Butyl Ether (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2690,
        "Product No.": "E138",
        "2nd Item Number": "D10012",
        "Description": "Ethyl Ether Anhydrous (Certified ACS), Fisher Chemical™",
        "Retest date": 5
    },
    {
        "Product code": 1734,
        "Product No.": "E195",
        "2nd Item Number": "D10019",
        "Description": "Ethyl acetate, HPLC Grade",
        "Retest date": 2
    },
    {
        "Product code": 1915,
        "Product No.": "E198",
        "2nd Item Number": "D10025",
        "Description": "Ethyl Ether, Anhydrous (Stabilized/HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2794,
        "Product No.": "H300",
        "2nd Item Number": "D10013",
        "Description": "Hexanes (Pesticide), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 826,
        "Product No.": "H302",
        "2nd Item Number": "D10009",
        "Description": "Hexanes, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7663,
        "Product No.": "H306",
        "2nd Item Number": "D10023",
        "Description": "n-Hexane, ACS Grade",
        "Retest date": 3
    },
    {
        "Product code": 2701,
        "Product No.": "H350",
        "2nd Item Number": "D10016",
        "Description": "n-Heptane, HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 7638,
        "Product No.": "H350D",
        "2nd Item Number": "D10043",
        "Description": "n-Heptane, Anhydrous ",
        "Retest date": 3
    },
    {
        "Product code": 3469,
        "Product No.": "O296",
        "2nd Item Number": "D10035",
        "Description": "Isooctane (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 2767,
        "Product No.": "P399",
        "2nd Item Number": "K13266",
        "Description": "Pentane (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 2582,
        "Product No.": "T290",
        "2nd Item Number": "D10017",
        "Description": "Toluene (HPLC), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 2899,
        "Product No.": "T397",
        "2nd Item Number": "D10010",
        "Description": "Tetrahydrofuran (Certified), Fisher Chemical",
        "Retest date": 3
    },
    {
        "Product code": 1695,
        "Product No.": "T425",
        "2nd Item Number": "D10005",
        "Description": "Tetrahydrofuran (HPLC), unstabilized, Fisher Chemical",
        "Retest date": 1
    },
    {
        "Product code": 1952,
        "Product No.": "W5",
        "2nd Item Number": "D10004",
        "Description": "Water (HPLC), Fisher Chemical",
        "Retest date": 2
    },
    {
        "Product code": 7529,
        "Product No.": "W6",
        "2nd Item Number": "K12468",
        "Description": "Water, Optima™ LC/MS Grade, Fisher Chemical™",
        "Retest date": 2
    },
    {
        "Product code": 1649,
        "Product No.": "X5",
        "2nd Item Number": "D10007",
        "Description": "Xylenes, ACS Grade",
        "Retest date": 5
    },
    {
        "Product code": 2678,
        "Product No.": "A383",
        "2nd Item Number": "D10026",
        "Description": "1-Butanol (n-Butyl alcohol),HPLC Grade",
        "Retest date": 3
    },
    {
        "Product code": 2195,
        "Product No.": "A412",
        "2nd Item Number": "D10006",
        "Description": "Methanol, ACS Grade ",
        "Retest date": 5
    }
]
                    </textarea>
                </div>

                <div>
                    <label for="dataInput" class="block text-sm font-medium text-gray-700 mb-1">성적서 데이터</label>
                    <textarea id="dataInput" class="w-full h-60 border border-gray-300 rounded-md p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" spellcheck="false">
Methanol, ACS Grade [67-56-1]
Product code. 2195 ACS Grade
Lot-R54321
TESTS	UNIT	SPECIFICATION	RESULTS
Appearance	-	Clear, colorless liquid	Passes
Assay (by GC)	%	≥ 99.8	99.9
Color (APHA)	APHA	≤ 10	&lt;10
Water	%	≤ 0.1	0.05
Residue after evaporation	ppm	≤ 10	2
Carbonyl compounds	%	≤ 0.001	&lt;0.001
Substances darkened by H2SO4	-	Passes test	Passes
Mfg. Date :2025-01-20
Exp. Date :5 years after Mfg. Date
                    </textarea>
                </div>
                
                <div class="mt-4 space-y-3">
                    <div>
                        <label for="manualProductNo" class="block text-sm font-medium text-gray-700">Product No. (수동 입력)</label>
                        <input type="text" id="manualProductNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualLotNumber" class="block text-sm font-medium text-gray-700">LOT Number (수동 입력)</label>
                        <input type="text" id="manualLotNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualDescription" class="block text-sm font-medium text-gray-700">Description (수동 입력)</label>
                        <input type="text" id="manualDescription" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                    <div>
                        <label for="manualRetestDate" class="block text-sm font-medium text-gray-700">Retest Date (수동 입력)</label>
                        <input type="text" id="manualRetestDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2">
                    </div>
                </div>

                <button onclick="populateCoa(true)" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    COA 생성 (Populate)
                </button>
                 <button onclick="window.print()" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out">
                    인쇄 (Print)
                </button>

                <!-- History Section -->
                <div id="historyContainer" class="mt-6 border-t pt-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">History</h3>
                        <button onclick="clearHistory()" class="text-sm text-red-500 hover:text-red-700">Clear History</button>
                    </div>
                    <div id="historyList" class="mt-2 max-h-32 overflow-y-auto border rounded-md p-2 bg-gray-50 space-y-1">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- COA Display Section -->
            <div class="lg:w-2/3">
                <div id="coa-container" class="bg-white p-8 sm:p-12 rounded-lg shadow-lg flex flex-col min-h-screen print:min-h-[100vh]">
                    <header class="flex justify-between items-start mb-8">
                        <div>
                            <img src="logo.png" alt="Company Logo" class="h-16">
                        </div>
                        <div class="text-right text-xs text-gray-600">
                            <p class="font-bold text-base">Thermo Fisher Scientific Korea</p>
                            <p class="font-bold mt-2">(Incheon Airport Logistics Complex)</p>
                            <p>D5,D6 150 Gonghangdong-ro 296 beon-gil</p>
                            <p>Jung-gu, Incheon 2239, Korea</p>
                            <p>Tel. +82-2-2023-0600</p>
                            <p>Fax. +82-2-6196-5501,2</p>
                        </div>
                    </header>

                    <h2 class="text-center text-3xl font-bold my-2 pb-4 border-b-4 border-gray-800">Certificate of Analysis</h2>

                    <div class="mb-2 text-sm space-y-1 pt-0 font-arial">
                        <div class="flex"><strong class="w-48 font-normal">Product No.:</strong><span id="productNo"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">LOT Number:</strong><span id="lotNumber"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">CAS Number:</strong><span id="casNumber"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Description:</strong><span id="description"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Quality Test/Release Date:</strong><span id="releaseDate"></span></div>
                        <div class="flex"><strong class="w-48 font-normal">Retest Date:</strong><span id="retestDate"></span></div>
                    </div>
			<div class="flex-grow">
                    		<table class="w-full border-collapse text-sm font-arial">
                        		<thead>
                            			<tr class="border-b-4 border-gray-800">
                                		<th class="pb-2 p-2 text-left font-semibold">Result Name</th>
                                		<th class="pb-2 p-2 text-left font-semibold">Units</th>
                                		<th class="pb-2 p-2 text-left font-semibold">Specifications</th>
                                		<th class="pb-2 p-2 text-left font-semibold">Test Value</th>
                            		</tr>
                        	</thead>
                        	<tbody id="resultsTableBody">
                            		<!-- Rows will be inserted by JavaScript -->
                        	</tbody>
                    	  </table>
                    </div>

                    <footer class="mt-12 pt-4">
                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-500 w-2/3">
                                <p>Note: The data listed is valid for all package sizes of this lot of this product, expressed as an extension of this catalog number listed above. If there are any questions with this certificate, please call at (82)-2-2023-0600.</p>
                                <p class="mt-2">*Based on suggested storage condition.</p>
                            </div>
                            <div class="text-center">
                                 <img src="sign.png" alt="Signature" class="h-16 mx-auto">
                                 <p class="font-semibold mt-2">Guseon.Jeong - Quality Control Supervisor</p>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <script>
        const HISTORY_KEY = 'coaGeneratorHistory';

        function searchDuksanLotNumber() {
            const lotNumber = document.getElementById('duksanLotNumberInput').value.trim();
            if (lotNumber) {
                const url = `https://duksan.kr/page/03/lot_print.php?lot_num=${lotNumber}`;
                window.open(url, '_blank');
            } else {
                alert("LOT 번호를 입력해주세요.");
            }
        }
        document.getElementById('duksanLotNumberInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchDuksanLotNumber();
            }
        });
        
        /**
         * Calculates a date string in YYYY-MM-DD format.
         * @param {string} baseDateStr - The starting date in 'YYYY-MM-DD' format.
         * @param {number} yearsToAdd - The number of years to add.
         * @returns {string} The calculated date string or an empty string if invalid.
         */
        function calculateDate(baseDateStr, yearsToAdd) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(baseDateStr) || !Number.isFinite(yearsToAdd)) {
                return '';
            }
            try {
                const date = new Date(baseDateStr);
                date.setFullYear(date.getFullYear() + yearsToAdd);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate() - 1).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("Error calculating date:", e);
                return '';
            }
        }


        function populateCoa(saveToHistory = false) {
            // Clear previous UI
            const elements = {
                productNo: document.getElementById('productNo'),
                lotNumber: document.getElementById('lotNumber'),
                casNumber: document.getElementById('casNumber'),
                description: document.getElementById('description'),
                releaseDate: document.getElementById('releaseDate'),
                retestDate: document.getElementById('retestDate'),
                tableBody: document.getElementById('resultsTableBody')
            };
            Object.values(elements).forEach(el => el.innerHTML = '');

            // Get manual inputs
            const manualInputs = {
                productNo: document.getElementById('manualProductNo').value.trim(),
                lotNumber: document.getElementById('manualLotNumber').value.trim(),
                description: document.getElementById('manualDescription').value.trim(),
                retestDate: document.getElementById('manualRetestDate').value.trim()
            };

            // Parse product database
            let productDatabase = [];
            try {
                productDatabase = JSON.parse(document.getElementById('excelDataInput').value.trim());
            } catch (e) {
                console.error("Invalid JSON in product database:", e);
                alert("제품 데이터 형식이 올바르지 않습니다.");
                return;
            }

            const rawData = document.getElementById('dataInput').value;
            const lines = rawData.split('\n');
            
            // --- 1. Extract all possible info from raw text ---
            let parsedInfo = {
                productCode: '',
                lotNumber: '',
                casNumber: '',
                description: '',
                mfgDate: '',
                expDateText: '' // Store the raw text from Exp. Date line
            };

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                if (lowerLine.startsWith('product code.')) {
                    const match = line.match(/Product code\.\s*(\d+)/);
                    if (match && match[1]) parsedInfo.productCode = match[1];
                }
                if (lowerLine.startsWith('lot-')) {
                    parsedInfo.lotNumber = line.split('-')[1]?.trim() || '';
                }
                if (line.includes('[') && line.includes(']')) {
                    parsedInfo.description = line.substring(0, line.indexOf('[')).trim();
                    parsedInfo.casNumber = line.substring(line.indexOf('[') + 1, line.indexOf(']')).trim();
                }
                if (lowerLine.startsWith('mfg. date')) {
                     const dateMatch = line.match(/\d{4}-\d{2}-\d{2}/);
                     if (dateMatch) parsedInfo.mfgDate = dateMatch[0];
                }
                if (lowerLine.startsWith('exp. date')) {
                    parsedInfo.expDateText = line.split(':')[1]?.trim() || '';
                }
            });

            // --- 2. Look up product in DB ---
            let productFromDb = null;
            if (parsedInfo.productCode && productDatabase.length > 0) {
                productFromDb = productDatabase.find(p => String(p["Product code"]) === parsedInfo.productCode);
            }

            // --- 3. Populate final values based on priority ---
            elements.productNo.textContent = manualInputs.productNo || (productFromDb ? productFromDb["Product No."] : '');
            elements.description.textContent = manualInputs.description || (productFromDb ? productFromDb["Description"] : parsedInfo.description);
            elements.lotNumber.textContent = manualInputs.lotNumber || parsedInfo.lotNumber;
            elements.casNumber.textContent = parsedInfo.casNumber;
            elements.releaseDate.textContent = parsedInfo.mfgDate;
            
            // Retest Date Priority Logic
            let finalRetestDate = '';
            if (manualInputs.retestDate) {
                finalRetestDate = manualInputs.retestDate;
            } else if (parsedInfo.expDateText && parsedInfo.mfgDate) {
                 const yearsMatch = parsedInfo.expDateText.match(/(\d+)\s*years/);
                 if (yearsMatch && yearsMatch[1]) {
                     const years = parseInt(yearsMatch[1], 10);
                     finalRetestDate = calculateDate(parsedInfo.mfgDate, years);
                 } else {
                    finalRetestDate = parsedInfo.expDateText; // If not 'X years...', show as is
                 }
            } else if (productFromDb && parsedInfo.mfgDate) {
                const years = parseInt(productFromDb["Retest date"], 10);
                finalRetestDate = calculateDate(parsedInfo.mfgDate, years);
            }
            elements.retestDate.textContent = finalRetestDate;

            // --- 4. Populate table ---
            let isTableData = false;
            lines.forEach(line => {
                if (line.toLowerCase().startsWith('tests\tunit\tspecification\tresults')) {
                    isTableData = true;
                    return;
                }
                if (line.toLowerCase().startsWith('mfg. date')) {
                    isTableData = false;
                }
                if (isTableData && line.trim()) {
                    const parts = line.split('\t');
                    if (parts.length >= 4) {
                        const [resultName, units, specs, testValue] = parts;
                        const row = `<tr><td class="px-2 py-0.5">${resultName.trim()}</td><td class="px-2 py-0.5">${units.trim()}</td><td class="px-2 py-0.5">${specs.trim()}</td><td class="px-2 py-0.5">${testValue.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td></tr>`;
                        elements.tableBody.innerHTML += row;
                    }
                }
            });

            // --- 5. Save to history ---
            if (saveToHistory) {
                const historyEntry = {
                    rawData: rawData,
                    productNo: elements.productNo.textContent,
                    lotNumber: elements.lotNumber.textContent,
                    manualProductNo: manualInputs.productNo,
                    manualLotNumber: manualInputs.lotNumber,
                    manualDescription: manualInputs.description,
                    manualRetestDate: manualInputs.retestDate,
                    timestamp: new Date().toISOString()
                };
                addHistoryEntry(historyEntry);
            }
        }

        // --- History Functions ---
        function getHistory() {
            const historyJson = localStorage.getItem(HISTORY_KEY);
            return historyJson ? JSON.parse(historyJson) : [];
        }

        function addHistoryEntry(entry) {
            if (!entry.lotNumber && !entry.productNo) return;
            let history = getHistory();
            history = history.filter(item => !(item.lotNumber === entry.lotNumber && item.productNo === entry.productNo));
            history.unshift(entry);
            if (history.length > 20) {
                history.pop();
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            loadHistoryDisplay();
        }

        function loadHistoryDisplay() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-xs text-gray-500 text-center p-2">No history yet.</p>';
                return;
            }

            history.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'p-2 border-b last:border-b-0 text-sm cursor-pointer hover:bg-blue-100 rounded';
                item.innerHTML = `
                    <p class="font-semibold truncate">No.: ${entry.productNo || 'N/A'}</p>
                    <p class="text-xs text-gray-600">Lot: ${entry.lotNumber || 'N/A'}</p>
                `;
                item.onclick = () => applyHistoryEntry(index);
                historyList.appendChild(item);
            });
        }

        function applyHistoryEntry(index) {
            const history = getHistory();
            const entry = history[index];
            if (entry) {
                document.getElementById('dataInput').value = entry.rawData;
                document.getElementById('manualProductNo').value = entry.manualProductNo || '';
                document.getElementById('manualLotNumber').value = entry.manualLotNumber || '';
                document.getElementById('manualDescription').value = entry.manualDescription || '';
                document.getElementById('manualRetestDate').value = entry.manualRetestDate || '';
                populateCoa(false);
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistoryDisplay();
            }
        }

        window.onload = () => {
            populateCoa(false);
            loadHistoryDisplay();
        };
    </script>
</body>
</html>

